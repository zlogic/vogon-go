{{ define "content" }}
<p class="title">Report</p>
<div class="container is-widescreen">
  <div id="reportTarget" class="content"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js" integrity="sha512-vBmx0N/uQOXznm/Nbkp7h0P1RfLSj0HQrFSzV8m7rOGyj30fYAOKHYvCNez+yM8IrfnW0TCodDEjRqf6fodf/Q==" crossorigin="anonymous"></script>
<script>
  // Load CSS
  Chart.platform.disableCSSInjection = true;
  document.head.insertAdjacentHTML("beforeend", '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" integrity="sha512-/zs32ZEJh+/EO2N1b0PEdoA10JkdC3zJ8L5FTiQu82LR9S/rOQNfQN7U59U9BC12swNeRAz3HSzIL2vpp4fv3w==" crossorigin="anonymous" />');
</script>
<script>
  var params = {
    filterDescription: '{{ index .Form "filterDescription" 0 }}',
    filterFrom: '{{ index .Form "filterFrom" 0 }}',
    filterTo: '{{ index .Form "filterTo" 0 }}',
    filterTags: '{{ index .Form "filterTags" 0 }}',
    filterAccounts: '{{ index .Form "filterAccounts" 0 }}',
    filterIncludeExpenseIncome: '{{ index .Form "filterIncludeExpenseIncome" 0 }}',
    filterIncludeTransfer: '{{ index .Form "filterIncludeTransfer" 0 }}'
  };
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  var reportTarget = document.getElementById("reportTarget");
  var balanceChartOptions = {
    responsive: true,
    tooltips: {
      mode: 'nearest',
      intersect: false,
    },
    legend: {
      display: false,
    },
    hover: {
      mode: 'nearest',
      intersect: false
    },
    scales: {
      xAxes: [{
        type: 'time',
        distribution: 'linear',
        time: {
          unit: 'day',
          minUnit: 'day'
        },
        ticks: {
          source: 'auto',
          autoSkip: true
        }
      }],
      yAxes: [{
        scaleLabel: {
          display: true,
          labelString: 'value'
        }
      }]
    }
  };
  var tagsChartOptions = {
    responsive: true,
    tooltips: {
      mode: 'point',
      intersect: false,
      callbacks: {
        title: function() {}
      }
    },
    legend: {
      display: false,
    },
    scales: {
      xAxes: [{
        stacked: true,
      }],
      yAxes: [{
        stacked: true
      }]
    }
  };
  var colors = [
		'#4dc9f6',
		'#f67019',
		'#f53794',
		'#537bc4',
		'#acc236',
		'#166a8f',
		'#00a950',
		'#58595b',
		'#8549ba'
	];

  var addProgress = function() {
    removeChildren(reportTarget);
    reportTarget.insertAdjacentHTML("afterbegin", '<progress class="progress is-primary" max="100"></progress>');
  }
  var updateReport = function(report) {
    removeChildren(reportTarget);
    for (var currency in report.BalanceChart) {
      var currencyChartDiv = document.createElement("div");
      reportTarget.append(currencyChartDiv);
      var currencyChartTitle = document.createElement("h3")
      currencyChartDiv.append(currencyChartTitle);
      currencyChartTitle.textContent = "Balance for "+ currency;
      var currencyChart = report.BalanceChart[currency];
      var data = [];
      for (var date in currencyChart)
        data.push({t: date, y: (currencyChart[date]/100).toFixed(2)});
      var dataset = {
        datasets: [{
          radius: 0,
          data: data,
          backgroundColor: colors[0],
          borderColor: colors[0],
          steppedLine: 'before'
        }]
      }
      var ctx = document.createElement("canvas");
      currencyChartDiv.append(ctx);
      var balanceChart = new Chart(ctx, {
        type: 'line',
        data: dataset,
        options: balanceChartOptions
      });
    }
    for (var currency in report.TagsChart) {
      var tagsChartDiv = document.createElement("div");
      reportTarget.append(tagsChartDiv);
      var tagsChartTitle = document.createElement("h3")
      tagsChartDiv.append(tagsChartTitle);
      tagsChartTitle.textContent = "Tags for "+ currency;
      var tagsChart = report.TagsChart[currency];
      var tags = {};
      var appendTag = function(tag){
        tags[tag] = null;
      };
      Object.keys(tagsChart.Positive).forEach(appendTag);
      Object.keys(tagsChart.Negative).forEach(appendTag);
      Object.keys(tagsChart.Transfer).forEach(appendTag);
      tags = Object.keys(tags);
      var incomeData = [];
      var expenseData = [];
      var transferData = [];
      var convertAmount = function(amount) {
        if (amount !== null && amount !== undefined) {
          return (amount/100).toFixed(2);
        }
        return 0.00;
      }
      var tagDatasets = [];
      var getColor = function(i){
        var colorIndex = i % colors.length;
        return colors[colorIndex];
      }
      for (var i in tags) {
        var tag = tags[i];
        tagDatasets.push({
          label: tags[i],
          data: [
            convertAmount(tagsChart.Positive[tag]),
            convertAmount(tagsChart.Negative[tag]),
            convertAmount(tagsChart.Transfer[tag])
          ],
          backgroundColor: getColor(i)
        });
      }
      var dataset = {
        labels: ['Income','Expense','Transfer'],
        datasets: tagDatasets
      };
      var ctx = document.createElement("canvas");
      tagsChartDiv.append(ctx);
      var tagsChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: dataset,
        options: tagsChartOptions
      });
    }
  }

  var loadData = function() {
    addProgress();
    reqPostForm("api/report", params, function(data) {
      data = JSON.parse(data);
      updateReport(data);
    }, function() {
      removeChildren(reportTarget);
      reportTarget.insertAdjacentHTML("afterbegin", '<div class="notification is-danger animate__animated animate__flipInX" role="alert">Failed to generate report.</div>')
    });
  }
  loadData();
});
</script>
{{ end }}
